<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cart — Edunancial</title>
  <link rel="stylesheet" href="/css/cart.css">
  <!-- PASTE YOUR LIVE CLIENT ID BELOW -->
  <script src="https://www.paypal.com/sdk/js?client-id=REPLACE_WITH_YOUR_LIVE_CLIENT_ID&currency=USD" data-sdk-integration-source="edunancial-cart"></script>
</head>
<body>
  <header class="topbar">
    <div class="brand">EDUNANCIAL</div>
    <nav class="navlinks">
      <a href="/index.html">Home</a>
      <a href="/books.html">Books</a>
      <a href="/courses.html">Courses</a>
      <a href="/payments.html">Payments</a>
      <a href="/call-center.html">Call Center</a>
      <a href="/vendor-program.html">Vendor Program</a>
      <a href="/contact.html">Contact</a>
      <a href="/privacy.html">Privacy</a>
      <a href="/terms.html">Terms</a>
      <a href="/refunds.html">Refunds</a>
      <a href="/our-story.html">Our Story</a>
    </nav>
    <div class="lang">
      <a class="pill on">EN</a>
      <a class="pill" href="/es-cart.html">ES</a>
    </div>
  </header>

  <main class="container">
    <h1>Checkout</h1>

    <section class="panel">
      <h2>Your cart</h2>
      <div id="cartTable"></div>
      <div class="cart-actions">
        <a class="btn-outline" href="/books.html">Add books</a>
        <a class="btn-outline" href="/courses.html">Add courses</a>
      </div>
    </section>

    <section class="panel">
      <h2>Discounts & eligibility</h2>
      <div class="grid">
        <div>
          <label class="lbl">Select your age group:</label>
          <div class="radios">
            <label><input type="radio" name="age" value="adult"> 18 or older</label>
            <label><input type="radio" name="age" value="under18"> Under 18</label>
          </div>
        </div>
        <div>
          <label for="promo" class="lbl">Discount / Under-18 Code</label>
          <input id="promo" type="text" placeholder="Enter code" autocomplete="off" />
          <small class="muted">We ignore spaces and case.</small>
        </div>
        <div>
          <label for="buyerEmail" class="lbl">Email for receipt & Zoom invite</label>
          <input id="buyerEmail" type="email" placeholder="name@example.com" autocomplete="email" />
        </div>
      </div>
    </section>

    <section class="panel">
      <h2>Summary</h2>
      <div id="summary"></div>
      <div id="paypal-button-container"></div>
      <p class="tos">By paying you agree to our <a href="/terms.html">Terms</a> and <a href="/refunds.html">Refunds</a>.</p>
    </section>
  </main>

  <footer class="foot">© 2025 Edunancial, Inc. • All rights reserved.</footer>

  <script>
/* ---------- PRODUCT CATALOG (edit prices/titles here) ---------- */
const PRODUCTS = [
  { id: "EDN-CRS-MIX-001", type:"course", name:"Edunancial Mini Course", price:75 },
  // 8 books (example titles — replace as you wish)
  { id:"B-RED-1", type:"book", name:"Real Estate Basics (Red 1)", price:19 },
  { id:"B-RED-2", type:"book", name:"Tax Liens & Deeds (Red 2)", price:29 },
  { id:"B-WHT-1", type:"book", name:"Paper Assets 101 (White 1)", price:17 },
  { id:"B-WHT-2", type:"book", name:"Investing Frameworks (White 2)", price:21 },
  { id:"B-BLU-1", type:"book", name:"Start a Simple Business (Blue 1)", price:18 },
  { id:"B-BLU-2", type:"book", name:"Business Systems (Blue 2)", price:24 },
  { id:"B-BLU-3", type:"book", name:"Sales & Habits (Blue 3)", price:16 },
  { id:"B-MIX-1", type:"book", name:"Foundations Workbook", price:15 },
];

/* ---------- DISCOUNT RULES ----------
   Codes like PR12345$$$ (under-18 only) or PR12345$$ (all ages).
   Each eligible item is priced at DISCOUNT_PRICE_PER_ITEM.
----------------------------------------------------------------- */
const DISCOUNT_PRICE_PER_ITEM = 1; // <- change if needed
function normalizeCode(s){ return (s||"").toUpperCase().replace(/\s+/g,""); }
function parseCode(raw){
  const c = normalizeCode(raw);
  if(!/^PR[0-9]+(\${2,3})$/.test(c)) return null;
  const under18Only = c.endsWith("$$$");
  return { code:c, under18Only };
}

/* ---------- CART STATE (persisted in localStorage) ---------- */
const STORAGE_KEY = "edn_cart_v1";
function loadCart(){
  try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; }
  catch(e){ return []; }
}
function saveCart(cart){ localStorage.setItem(STORAGE_KEY, JSON.stringify(cart)); }

// Allow adding via query e.g. /cart.html?add=EDN-CRS-MIX-001
(function(){
  const p = new URLSearchParams(location.search);
  const add = p.get("add");
  if(add){
    const item = PRODUCTS.find(x=>x.id===add);
    if(item){
      const cart = loadCart();
      const line = cart.find(x=>x.id===add);
      if(line) line.qty += 1; else cart.push({ id:item.id, qty:1 });
      saveCart(cart);
      history.replaceState({}, "", location.pathname);
    }
  }
})();

/* ---------- RENDER CART ---------- */
const cartTable = document.getElementById("cartTable");
const summaryEl = document.getElementById("summary");
const promoEl = document.getElementById("promo");
const emailEl = document.getElementById("buyerEmail");

function money(n){ return `$${n.toFixed(2)}`; }

function computeTotals(cart, ageGroup, promoRaw){
  const promo = parseCode(promoRaw);
  const discountEligible = promo && (!promo.under18Only || ageGroup==="under18");
  let lines = [];
  let subtotal = 0, discount = 0;

  for(const row of cart){
    const p = PRODUCTS.find(x=>x.id===row.id);
    if(!p) continue;
    const origLine = p.price * row.qty;
    let linePrice;
    if(discountEligible){
      // every item gets priced at DISCOUNT_PRICE_PER_ITEM
      linePrice = DISCOUNT_PRICE_PER_ITEM * row.qty;
      discount += (p.price - DISCOUNT_PRICE_PER_ITEM) * row.qty;
    } else {
      linePrice = origLine;
    }
    subtotal += linePrice;
    lines.push({ ...p, qty:row.qty, linePrice });
  }
  return { lines, subtotal, discount, discountEligible };
}

function render(){
  const cart = loadCart();
  if(cart.length===0){
    cartTable.innerHTML = `<p>Your cart is empty.</p>`;
  } else {
    cartTable.innerHTML = `
      <table class="table">
        <thead><tr><th>Item</th><th class="num">Price</th><th class="num">Qty</th><th class="num">Line</th><th></th></tr></thead>
        <tbody>
          ${cart.map(r=>{
            const p = PRODUCTS.find(x=>x.id===r.id);
            return `<tr>
              <td>${p?p.name:r.id}</td>
              <td class="num">${p?money(p.price):"-"}</td>
              <td class="num">
                <button class="qty" data-id="${r.id}" data-d="-1">−</button>
                <span class="q">${r.qty}</span>
                <button class="qty" data-id="${r.id}" data-d="1">+</button>
              </td>
              <td class="num">${p?money(p.price*r.qty):"-"}</td>
              <td><button class="link rm" data-id="${r.id}">Remove</button></td>
            </tr>`;
          }).join("")}
        </tbody>
      </table>
    `;
    cartTable.querySelectorAll(".qty").forEach(b=>{
      b.onclick = () => {
        const id = b.dataset.id, d = Number(b.dataset.d);
        const cart = loadCart();
        const line = cart.find(x=>x.id===id);
        if(line){ line.qty = Math.max(1, line.qty + d); saveCart(cart); render(); recalc(); }
      };
    });
    cartTable.querySelectorAll(".rm").forEach(b=>{
      b.onclick = () => {
        let cart = loadCart().filter(x=>x.id!==b.dataset.id);
        saveCart(cart); render(); recalc();
      };
    });
  }
}
render();

function getAge(){ const r=[...document.querySelectorAll('input[name="age"]')].find(x=>x.checked); return r?r.value:null; }

function recalc(){
  const totals = computeTotals(loadCart(), getAge(), promoEl.value);
  if(totals.discount > 0){
    summaryEl.innerHTML = `
      <div class="sumrow"><span>Items:</span><span>${totals.lines.length}</span></div>
      <div class="sumrow"><span>Discount:</span><span>−${money(totals.discount)}</span></div>
      <div class="sumrow total"><span>Total:</span><span>${money(totals.subtotal)}</span></div>
    `;
  } else {
    summaryEl.innerHTML = `
      <div class="sumrow"><span>Items:</span><span>${totals.lines.length}</span></div>
      <div class="sumrow total"><span>Total:</span><span>${money(totals.subtotal)}</span></div>
    `;
  }
  paypalButtonRefresh(totals);
}
promoEl.addEventListener("input", recalc);
document.querySelectorAll('input[name="age"]').forEach(r=>r.addEventListener("change", recalc));
recalc();

/* ---------- PAYPAL: create & capture via Netlify Functions ---------- */
let paypalBtn;
function paypalButtonRefresh(totals){
  const container = document.getElementById("paypal-button-container");
  container.innerHTML = "";
  if(loadCart().length===0) return;

  paypal.Buttons({
    style:{ layout:'vertical', shape:'rect', label:'paypal' },
    onClick: function(data, actions){
      // Validate email & age/code before creating order
      const age = getAge();
      const promo = parseCode(promoEl.value);
      if(!emailEl.value || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(emailEl.value)){
        alert("Enter a valid email address.");
        return actions.reject();
      }
      if(!age){
        alert("Select your age group.");
        return actions.reject();
      }
      if(promo && promo.under18Only && age!=="under18"){
        alert("That code is for under-18 only.");
        return actions.reject();
      }
      return actions.resolve();
    },
    createOrder: async () => {
      const body = {
        cart: loadCart(),
        age: getAge(),
        promo: normalizeCode(promoEl.value),
        email: emailEl.value
      };
      const res = await fetch("/.netlify/functions/create-order", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(body)
      });
      if(!res.ok){ const t=await res.text(); throw new Error(t||"Create order failed"); }
      const json = await res.json();
      return json.id; // PayPal order id
    },
    onApprove: async (data) => {
      const res = await fetch("/.netlify/functions/capture-order", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ orderID: data.orderID })
      });
      if(!res.ok){ const t=await res.text(); alert("Capture failed: "+t); return; }
      // Success — clear cart and send to thank-you
      localStorage.removeItem(STORAGE_KEY);
      window.location.href="/thank-you.html";
    },
    onError: (err) => {
      console.error(err);
      alert("Payment error. Please try again.");
    }
  }).render(container);
}
  </script>
</body>
</html>
