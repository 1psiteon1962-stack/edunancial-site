<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Cart â€” Edunancial</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
</head>
<body>
  <script src="/header.js"></script>
  <script src="/js/membership-gate.js"></script>

  <main class="container" style="padding:18px 0">
    <h1>Cart</h1>
    <div id="cartBox" class="card" style="border:1px solid #e6e6e6;border-radius:12px;padding:16px"></div>
    <p class="row" style="margin-top:14px">
      <a class="btn" href="/books.html">Browse Books</a>
      <a class="btn" href="/courses.html">Browse Courses</a>
      <a id="toCheckout" class="btn" href="/checkout.html">Proceed to Checkout</a>
    </p>
  </main>

<script>
let CONFIG={DISCOUNT_CODES:{}};
(async()=>{ try{ const r=await fetch("/config.json",{cache:"no-store"}); if(r.ok) CONFIG=await r.json(); }catch(_){} render(); })();

function priceAfter(item){
  const base = Number(item.price||0);
  const qty  = Number(item.qty||1);
  const code = (item.code||"").trim();
  let off = 0;
  if (code && CONFIG.DISCOUNT_CODES && (code in CONFIG.DISCOUNT_CODES)) {
    off = Number(CONFIG.DISCOUNT_CODES[code]||0);
  }
  const p = Math.max(0, base - off);
  return { unit: p, line: p * qty, off };
}
function removeItem(i){
  const cart = JSON.parse(localStorage.getItem("edn_cart")||"[]");
  cart.splice(i,1);
  localStorage.setItem("edn_cart", JSON.stringify(cart));
  render();
}
function updateQty(i, val){
  const cart = JSON.parse(localStorage.getItem("edn_cart")||"[]");
  cart[i].qty = Math.max(1, Number(val||1));
  localStorage.setItem("edn_cart", JSON.stringify(cart));
  render();
}
function updateCode(i, val){
  const cart = JSON.parse(localStorage.getItem("edn_cart")||"[]");
  cart[i].code = (val||"").trim();
  localStorage.setItem("edn_cart", JSON.stringify(cart));
  render();
}

function render(){
  const cart = JSON.parse(localStorage.getItem("edn_cart")||"[]");
  if(!cart.length){
    document.getElementById("cartBox").innerHTML = `
      <div style="padding:24px;text-align:center;color:#555">Your cart is empty.</div>`;
    return;
  }
  let rows = "";
  let subtotal=0, discounts=0;
  cart.forEach((it,idx)=>{
    const calc = priceAfter(it);
    subtotal += calc.line;
    discounts += Math.max(0, (Number(it.price)-calc.unit)) * Number(it.qty);
    rows += `
      <tr>
        <td>${it.name}<div class="small">SKU: ${it.sku}</div></td>
        <td>$${Number(it.price).toFixed(2)}</td>
        <td><input type="number" min="1" value="${it.qty}" style="width:72px" onchange="updateQty(${idx},this.value)"></td>
        <td><input value="${(it.code||"")}" placeholder="code" style="width:120px" onchange="updateCode(${idx},this.value)"></td>
        <td>$${calc.unit.toFixed(2)}</td>
        <td>$${calc.line.toFixed(2)}</td>
        <td><button class="btn" onclick="removeItem(${idx})">Remove</button></td>
      </tr>`;
  });
  document.getElementById("cartBox").innerHTML = `
    <div style="overflow:auto">
      <table style="width:100%;border-collapse:collapse">
        <thead>
          <tr style="text-align:left;border-bottom:1px solid #e6e6e6">
            <th>Item</th><th>Base</th><th>Qty</th><th>Code</th><th>Unit</th><th>Total</th><th></th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    </div>
    <div class="row" style="justify-content:flex-end;margin-top:12px">
      <div style="min-width:240px;border:1px solid #e6e6e6;border-radius:10px;padding:12px">
        <div>Subtotal: <strong>$${subtotal.toFixed(2)}</strong></div>
        <div class="small" style="color:#666">Discounts applied: $${discounts.toFixed(2)}</div>
      </div>
    </div>`;
}
</script>
</body>
</html>
