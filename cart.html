<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Cart — Edunancial</title>
<meta name="robots" content="noindex" />
<style>
  :root { --red:#c50000; --ink:#111; --muted:#666; }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--ink);background:#fff}
  header{background:var(--red);color:#000;font-weight:800;text-align:center;padding:14px 10px;letter-spacing:.4px}
  main{max-width:960px;margin:20px auto 60px;padding:0 14px;display:grid;gap:16px}
  .col{background:#fff;border:1px solid #e5e5e8;border-radius:12px;padding:16px;box-shadow:0 6px 20px rgba(0,0,0,.04)}
  h2{margin:0 0 10px}
  .item{display:flex;align-items:center;justify-content:space-between;border-top:1px dashed #eee;padding:10px 0}
  .item:first-of-type{border-top:0}
  .muted{color:var(--muted);font-size:14px}
  .row{display:flex;gap:10px;align-items:center}
  .qty{width:58px;padding:8px;border:1px solid #ccc;border-radius:8px}
  .btn{display:inline-block;padding:8px 10px;border-radius:8px;border:1px solid #1e3a8a;background:#0b2e4f;color:#fff;text-decoration:none;font-weight:700;cursor:pointer}
  .btn.sec{background:#f6f6f9;color:#0b2e4f;border-color:#cbd5e1}
  .right{margin-left:auto}
  .totals .row{justify-content:space-between;margin:6px 0}
  .grand{font-size:22px;font-weight:900}
  #paypal-button-container{margin-top:14px;min-height:44px}
  .help{display:none;margin-top:12px;padding:12px;border:1px solid #e53935;background:#ffebee;color:#b71c1c;border-radius:8px;font-size:.95rem}
  .err{display:none;margin-top:10px;padding:10px;border-left:4px solid #c50000;background:#fff4f4;color:#6b1111;border-radius:6px}
  input[type="text"],input[type="number"]{padding:10px;border:1px solid #cfcfd6;border-radius:8px;width:100%}
  label{font-weight:700;display:block;margin:8px 0 4px}
  .grid{display:grid;gap:10px}
  @media(min-width:880px){ main{grid-template-columns:1.1fr .9fr} }
</style>

<!-- PayPal SDK — LIVE Client ID already embedded -->
<script src="https://www.paypal.com/sdk/js?client-id=AX2d6TWWguiffoGPIhKQg5D4avOwsBajcdl-S2tJ7mAHckP_sxucKRXdCgYyyQRQYqKGvWlE2wx4GAxw&currency=USD&components=buttons"></script>
</head>
<body>
<header>EDUNANCIAL • CART</header>

<main>
  <!-- Left: Simple catalog + “add custom item” -->
  <section class="col">
    <h2>Catalog</h2>
    <div class="muted">Add from here, or use “Add Custom Item” below to sell anything without setting it up in PayPal.</div>

    <!-- Example items (edit names/prices/SKUs as you like) -->
    <div id="catalog"></div>

    <hr style="border:none;border-top:1px solid #eee;margin:14px 0">
    <h3>Add Custom Item</h3>
    <div class="grid" style="grid-template-columns:1fr 1fr">
      <div>
        <label for="ci-name">Name</label>
        <input id="ci-name" type="text" placeholder="e.g., Private Coaching" />
      </div>
      <div>
        <label for="ci-sku">SKU</label>
        <input id="ci-sku" type="text" placeholder="e.g., EDN-COACH-001" />
      </div>
      <div>
        <label for="ci-price">Price (USD)</label>
        <input id="ci-price" type="number" min="0" step="0.01" placeholder="e.g., 99.00" />
      </div>
      <div>
        <label>&nbsp;</label>
        <button class="btn" id="ci-add">Add to Cart</button>
      </div>
    </div>
  </section>

  <!-- Right: Cart + discounts + PayPal -->
  <section class="col">
    <h2>Your Cart</h2>
    <div id="cartList" class="muted">Your cart is empty.</div>

    <div style="margin-top:12px" class="grid" id="discounts">
      <div class="row">
        <label class="row" style="margin:0"><input type="checkbox" id="under18" /> <span>I am under 18</span></label>
      </div>
      <div>
        <label for="code">Discount / Under-18 Code</label>
        <input id="code" type="text" placeholder="Enter code (PR12345$$ for $1 test)" />
      </div>
    </div>

    <div class="totals" style="margin-top:12px">
      <div class="row"><span>Subtotal</span><span id="t-sub">$0.00</span></div>
      <div class="row"><span>Early-bird</span><span id="t-eb">-$0.00</span></div>
      <div class="row"><span>Under-18 code</span><span id="t-u18">-$0.00</span></div>
      <div class="row grand"><span>Total</span><span id="t-grand">$0.00</span></div>
    </div>

    <div id="paypal-button-container"></div>
    <div id="pp-error" class="err"></div>
    <div id="pp-help" class="help">
      ⚠️ PayPal checkout button didn’t load.<br><br>
      Please disable <strong>ad-blockers</strong> or <strong>Private DNS</strong> on your device/browser, or switch between Wi-Fi and mobile data. Then refresh. (Allow scripts from <em>paypal.com</em>.)
    </div>

    <p class="muted" style="margin-top:12px">By paying you agree to our <a href="/terms.html">Terms</a> &amp; <a href="/refunds.html">Refunds</a>.</p>
  </section>
</main>

<script>
/** -------- Catalog you can edit inline (no PayPal setup needed) -------- **/
const CATALOG = [
  { sku:'EDN-MINI-EM-001', name:'Mini Course — Edunancial Method (EN)', price:75.00 },
  { sku:'EDN-COURSE-BLUE', name:'Business Formation (Blue Course)',     price:199.00 },
  { sku:'EDN-COURSE-RED',  name:'Tax Liens & Tax Deeds (Red Course)',   price:149.00 },
  { sku:'EDN-COURSE-WHITE',name:'Stock Skills for Youth (White Course)',price:129.00 }
];

/** -------------------- Basic cart in memory + localStorage -------------------- **/
let cart = JSON.parse(localStorage.getItem('edn_cart') || '[]');

function saveCart(){ localStorage.setItem('edn_cart', JSON.stringify(cart)); }

function money(n){ return '$' + (Math.round(n*100)/100).toFixed(2); }

function renderCatalog(){
  const wrap = document.getElementById('catalog');
  wrap.innerHTML = '';
  CATALOG.forEach((p,i)=>{
    const row = document.createElement('div');
    row.className = 'item';
    row.innerHTML = `
      <div>
        <div style="font-weight:800">${p.name}</div>
        <div class="muted">SKU: ${p.sku}</div>
      </div>
      <div class="row">
        <div style="font-weight:800">${money(p.price)}</div>
        <button class="btn sec" data-idx="${i}">Add</button>
      </div>
    `;
    wrap.appendChild(row);
  });
  wrap.querySelectorAll('button[data-idx]').forEach(btn=>{
    btn.addEventListener('click', e=>{
      const p = CATALOG[+e.currentTarget.dataset.idx];
      addToCart({ sku:p.sku, name:p.name, price:p.price, qty:1 });
    });
  });
}

function addToCart(item){
  const existing = cart.find(it=>it.sku===item.sku && it.price===item.price);
  if (existing) existing.qty += item.qty;
  else cart.push(item);
  saveCart(); renderCart();
}

function removeFromCart(sku){
  cart = cart.filter(it=>it.sku!==sku);
  saveCart(); renderCart();
}

function setQty(sku, qty){
  const it = cart.find(i=>i.sku===sku);
  if (it){ it.qty = Math.max(1, qty||1); saveCart(); renderCart(); }
}

function renderCart(){
  const list = document.getElementById('cartList');
  if (!cart.length){ list.innerHTML = 'Your cart is empty.'; updateTotals(); return; }

  list.innerHTML = '';
  cart.forEach(it=>{
    const row = document.createElement('div');
    row.className = 'item';
    row.innerHTML = `
      <div>
        <div style="font-weight:800">${it.name}</div>
        <div class="muted">SKU: ${it.sku}</div>
      </div>
      <div class="row right">
        <input class="qty" type="number" min="1" step="1" value="${it.qty}" />
        <div style="width:90px;text-align:right;font-weight:800">${money(it.price*it.qty)}</div>
        <button class="btn sec" data-remove="${it.sku}">Remove</button>
      </div>
    `;
    row.querySelector('.qty').addEventListener('change', e=> setQty(it.sku, +e.target.value));
    row.querySelector('[data-remove]').addEventListener('click', ()=> removeFromCart(it.sku));
    list.appendChild(row);
  });
  updateTotals();
}

/** -------------------- Discounts / totals (with $1 test) -------------------- **/
const TEST_CODE = 'PR12345$$';
const EARLY_RATE = 0.15; // early-bird 15% off (optional)
const EARLY_DEADLINE = new Date('2025-09-26T23:59:59-05:00');

function calcSubtotal(){ return cart.reduce((s,it)=>s + it.price*it.qty, 0); }

function updateTotals(){
  let sub = calcSubtotal();
  let early = (new Date() <= EARLY_DEADLINE) ? sub * EARLY_RATE : 0;
  let u18 = 0;
  const code = document.getElementById('code').value.trim();
  const under18 = document.getElementById('under18').checked;

  // Special $1 path if under 18 + code — drives grand to $1 (if sub>0)
  if (under18 && code === TEST_CODE && sub > 0){
    const current = Math.max(0, sub - early);
    u18 = Math.max(0, current - 1.00);
  }

  const grand = Math.max(0.01, sub - early - u18);

  document.getElementById('t-sub').textContent = money(sub);
  document.getElementById('t-eb').textContent  = '-' + money(early).slice(1);
  document.getElementById('t-u18').textContent = '-' + (u18 ? money(u18).slice(1) : '0.00');
  document.getElementById('t-grand').textContent = money(grand);

  return { sub, early, u18, grand };
}

['change','keyup'].forEach(ev=>{
  document.getElementById('under18').addEventListener(ev, updateTotals);
  document.getElementById('code').addEventListener(ev, updateTotals);
});

/** -------------------- Add custom item -------------------- **/
document.getElementById('ci-add').addEventListener('click', ()=>{
  const name = document.getElementById('ci-name').value.trim();
  const sku = (document.getElementById('ci-sku').value.trim() || 'EDN-CUSTOM-' + Math.random().toString(36).slice(2,8)).toUpperCase();
  const price = parseFloat(document.getElementById('ci-price').value);
  if (!name || !(price >= 0.01)){ alert('Enter a name and a price (>= 0.01).'); return; }
  addToCart({ sku, name, price, qty:1 });
  document.getElementById('ci-name').value = '';
  document.getElementById('ci-sku').value = '';
  document.getElementById('ci-price').value = '';
});

/** -------------------- Initialize UI -------------------- **/
renderCatalog(); renderCart();

/** -------------------- PayPal Buttons -------------------- **/
const $ppHelp  = document.getElementById('pp-help');
const $ppError = document.getElementById('pp-error');

function lineItems(){
  return cart.map(it=>({
    name: it.name.slice(0,127),
    sku: it.sku.slice(0,127),
    quantity: String(it.qty),
    unit_amount: { currency_code: 'USD', value: (Math.round(it.price*100)/100).toFixed(2) }
  }));
}

function renderPayPal(){
  if (!window.paypal || !paypal.Buttons){ $ppHelp.style.display='block'; return; }

  $ppHelp.style.display='none'; $ppError.style.display='none';
  document.getElementById('paypal-button-container').innerHTML = '';

  paypal.Buttons({
    style:{ layout:'vertical', color:'gold', shape:'rect', label:'paypal' },

    createOrder: (data, actions) => {
      if (!cart.length){ $ppError.textContent='Your cart is empty.'; $ppError.style.display='block'; throw new Error('Empty cart'); }
      const { sub, early, u18, grand } = updateTotals();
      // Build breakdown to send to PayPal (optional but nice)
      return actions.order.create({
        purchase_units: [{
          description: 'Edunancial Checkout',
          amount: {
            currency_code: 'USD',
            value: grand.toFixed(2),
            breakdown: {
              item_total: { currency_code:'USD', value: (sub).toFixed(2) },
              discount:   { currency_code:'USD', value: (early + u18).toFixed(2) }
            }
          },
          items: lineItems()
        }]
      });
    },

    onApprove: (data, actions) =>
      actions.order.capture().then(details => {
        // Clear the cart after successful payment
        cart = []; saveCart(); renderCart(); updateTotals();
        const params = new URLSearchParams({
          orderId: details.id || '',
          paid:    (details.purchase_units?.[0]?.amount?.value) || '',
          payer:   (details.payer?.name?.given_name) || 'Customer'
        }).toString();
        window.location.href = '/thank-you.html?' + params;
      }),

    onError: (err) => {
      $ppError.textContent = 'PayPal error: ' + (err && err.message ? err.message : 'Unknown error.');
      $ppError.style.display = 'block';
      $ppHelp.style.display = 'block';
    }
  }).render('#paypal-button-container')
    .catch(()=>{ $ppHelp.style.display='block'; });
}

document.addEventListener('DOMContentLoaded', ()=>{
  renderPayPal();
  // If the SDK or button is slow/blocked, show help after 5s
  setTimeout(()=>{
    const iframePresent = document.querySelector('#paypal-button-container iframe');
    if (!iframePresent) $ppHelp.style.display = 'block';
  }, 5000);
});
</script>
</body>
</html>
