<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Checkout — Edunancial</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
</head>
<body>
  <script src="/header.js"></script>
  <script src="/js/membership-gate.js"></script>

  <main class="container" style="padding:18px 0">
    <h1>Checkout</h1>
    <div id="sum" class="card" style="border:1px solid #e6e6e6;border-radius:12px;padding:16px;margin-bottom:14px"></div>

    <div class="card" style="border:1px solid #e6e6e6;border-radius:12px;padding:16px">
      <h3>Contact</h3>
      <div class="row" style="gap:10px;margin:8px 0">
        <input id="email" type="email" placeholder="Email" style="height:38px;border:1px solid #e6e6e6;border-radius:8px;padding:0 10px;width:280px">
        <input id="name" type="text" placeholder="Full name (optional)" style="height:38px;border:1px solid #e6e6e6;border-radius:8px;padding:0 10px;width:280px">
      </div>
      <button class="btn" id="ppBtn">Continue to PayPal</button>
    </div>
  </main>

<script>
let CONFIG={DISCOUNT_CODES:{}};
(async()=>{ try{ const r=await fetch("/config.json",{cache:"no-store"}); if(r.ok) CONFIG=await r.json(); }catch(_){} render(); })();

function priceAfter(item){
  const base = Number(item.price||0);
  const qty  = Number(item.qty||1);
  const code = (item.code||"").trim();
  let off = 0;
  if (code && CONFIG.DISCOUNT_CODES && (code in CONFIG.DISCOUNT_CODES)) {
    off = Number(CONFIG.DISCOUNT_CODES[code]||0);
  }
  const p = Math.max(0, base - off);
  return { unit: p, line: p * qty, off };
}

function render(){
  const cart = JSON.parse(localStorage.getItem("edn_cart")||"[]");
  if(!cart.length){ document.getElementById("sum").innerHTML = "Your cart is empty."; return; }
  let rows = ""; let total=0;
  cart.forEach(it=>{
    const c=priceAfter(it); total+=c.line;
    rows += `<tr><td>${it.name}<div class="small">SKU: ${it.sku} ${(it.code?`· Code: ${it.code}`:"")}</div></td>
    <td>${it.qty}</td><td>$${c.unit.toFixed(2)}</td><td>$${c.line.toFixed(2)}</td></tr>`;
  });
  document.getElementById("sum").innerHTML = `
    <div style="overflow:auto">
      <table style="width:100%;border-collapse:collapse">
        <thead><tr style="text-align:left;border-bottom:1px solid #e6e6e6">
          <th>Item</th><th>Qty</th><th>Unit</th><th>Total</th></tr></thead>
        <tbody>${rows}</tbody>
      </table>
    </div>
    <div class="row" style="justify-content:flex-end;margin-top:10px">
      <div style="min-width:220px"><strong>Amount due: $${total.toFixed(2)}</strong></div>
    </div>`;

  document.getElementById("ppBtn").onclick = async function(){
    const email = (document.getElementById("email").value||"").trim();
    if(!email){ alert("Enter email"); return; }
    const payload = { email, name:(document.getElementById("name").value||"").trim(), items:cart };
    try{
      const r = await fetch("/.netlify/functions/create-order", { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload) });
      if(r.ok){
        const data = await r.json();
        if (data && data.approval_url) { location.href = data.approval_url; return; }
      }
      // fallback
      const f = await fetch("/.netlify/functions/paypal-redirect", { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload) });
      const d = await f.json(); if(d && d.url){ location.href = d.url; return; }
      alert("Unable to initiate PayPal.");
    }catch(e){ alert("Checkout error"); }
  };
}
</script>
</body>
</html>
