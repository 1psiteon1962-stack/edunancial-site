<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Carrito — Edunancial</title>
<link rel="stylesheet" href="/style.css">
</head>
<body>
<div class="container">
  <h1>Carrito</h1>
  <section class="card" id="items"></section>

  <section class="card">
    <label>Código de descuento:</label>
    <input id="code" placeholder="">
    <button class="btn" id="apply">Aplicar</button>
    <div id="msg" class="small"></div>
  </section>

  <section class="card">
    <div>Subtotal: <strong id="sub">$0.00</strong></div>
    <div>Descuento: <strong id="disc">-$0.00</strong></div>
    <div>Total:    <strong id="tot">$0.00</strong></div>
    <button class="btn" id="checkout" style="margin-top:10px">Continuar a PayPal</button>
  </section>
</div>

<script src="/header.js?v=7" defer></script>
<script>
let cart=[], cfg, applied=null;
const $=s=>document.querySelector(s); const fmt=n=>'$'+Number(n||0).toFixed(2);
function load(){ cart=JSON.parse(localStorage.getItem('EDN_CART')||'[]'); }
function save(){ localStorage.setItem('EDN_CART', JSON.stringify(cart)); window.EDN.updateCartCount(); }
function render(){
  const el=$('#items'); el.innerHTML='';
  if(cart.length===0){ el.innerHTML='<p>Tu carrito está vacío.</p>'; tot(); return; }
  cart.forEach((it,i)=>{
    const row=document.createElement('div'); row.className='product';
    row.innerHTML=`<div><strong>${it.title}</strong> <span class="small">${it.sku}</span></div>
      <div>$${(+it.price).toFixed(2)} x <input type="number" min="1" value="${it.qty||1}" data-i="${i}" style="width:60px">
      <button data-rm="${i}">Quitar</button></div>`;
    el.appendChild(row);
  });
  el.addEventListener('input',e=>{
    if(e.target.matches('input[type="number"]')){
      const i=+e.target.dataset.i; cart[i].qty=Math.max(1, parseInt(e.target.value||'1',10)); save(); tot();
    }
  }, {once:true});
  el.addEventListener('click',e=>{
    const b=e.target.closest('button[data-rm]'); if(!b) return;
    const i=+b.dataset.rm; cart.splice(i,1); save(); render();
  }, {once:true});
  tot();
}
function tot(){
  const sub=cart.reduce((s,it)=>s+(+it.price)*(it.qty||1),0);
  let discount=0,total=sub;
  if(applied){
    if(applied.type==='percent') discount=sub*(applied.value/100);
    if(applied.type==='flat' && applied.value==='force-1') total=cart.reduce((s,it)=>s+1*(it.qty||1),0);
    else if(applied.type==='flat' && typeof applied.value==='number') discount=applied.value;
  }
  if(applied && applied.type!=='flat') total=sub-discount;
  $('#sub').textContent=fmt(sub); $('#disc').textContent='-'+fmt(discount); $('#tot').textContent=fmt(total);
  localStorage.setItem('EDN_CART_TOTALS', JSON.stringify({sub,discount,total}));
}
document.addEventListener('DOMContentLoaded', async ()=>{
  cfg=await (await fetch('/config.json?ts='+Date.now())).json();
  load(); render();
  $('#apply').addEventListener('click',()=>{
    const code=($('#code').value||'').trim().toLowerCase(); const d=cfg.discounts?.[code];
    if(!d){ $('#msg').textContent='Código no reconocido'; applied=null; tot(); return; }
    applied={...d}; $('#msg').textContent=`Aplicado ${code}`; tot();
  });
  $('#checkout').addEventListener('click', async ()=>{
    if(cart.length===0) return alert('Carrito vacío');
    const res=await fetch('/.netlify/functions/create-order',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({cart,applied})});
    const out=await res.json(); if(out && out.approvalUrl) location.href=out.approvalUrl; else alert('Falla al crear orden');
  });
});
</script>
</body>
</html>
