<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Carrito — Edunancial</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="/css-cart.css">
  <script src="/header.js" defer></script>
  <script src="https://www.paypal.com/sdk/js?components=buttons&currency=USD"></script>
</head>
<body>
  <header class="site-header">
    <a href="/es-index.html" class="logo">EDUNANCIAL</a>
    <nav>
      <a href="/es-books.html">Libros</a>
      <a href="/es-courses.html">Cursos</a>
      <a href="/es-cart.html">Carrito (<span id="cart-badge">0</span>)</a>
    </nav>
  </header>

  <main class="container">
    <h1>Carrito de compras</h1>
    <div id="cart-empty" class="card" style="display:none">
      Tu carrito está vacío. <a href="/es-books.html">Ver libros</a> o <a href="/es-courses.html">cursos</a>.
    </div>

    <div id="cart-table" class="card" style="display:none">
      <table>
        <thead><tr><th>Artículo</th><th>Precio</th><th>Cant.</th><th>Subtotal</th><th></th></tr></thead>
        <tbody id="cart-rows"></tbody>
      </table>
      <div class="totals">
        <div><strong>Total:</strong> $<span id="cart-total">0.00</span> USD</div>
      </div>
    </div>

    <form id="buyer-form" class="card" style="display:none">
      <h3>Datos del comprador</h3>
      <label>Correo electrónico (recibo/Zoom):<br>
        <input type="email" id="buyer-email" required placeholder="tú@ejemplo.com"></label><br><br>
      <label>Código de descuento / Menor de 18:<br>
        <input type="text" id="discount" placeholder="Código (opcional)">
      </label>
    </form>

    <div id="pay-card" class="card" style="display:none">
      <div id="paypal-button-container"></div>
      <small>Al pagar aceptas nuestros <a href="/es-terms.html">Términos</a> y <a href="/es-refunds.html">Reembolsos</a>.</small>
    </div>
  </main>

  <script>
  const CART_KEY="edn_cart_v1";
  function readCart(){ try{return JSON.parse(localStorage.getItem(CART_KEY))||{items:[]};}catch{return{items:[]};} }
  function writeCart(c){ localStorage.setItem(CART_KEY, JSON.stringify(c)); updateCartBadge(); }
  function updateCartBadge(){ const el=document.getElementById("cart-badge"); if(el){ const n=readCart().items.reduce((a,i)=>a+i.quantity,0); el.textContent=n; } }
  document.addEventListener("DOMContentLoaded", updateCartBadge);
  function setQty(id,variant,qty){ const c=readCart(); const i=c.items.findIndex(x=>x.id===id&&x.variant===variant); if(i>-1){ c.items[i].quantity=Math.max(1,qty|0); writeCart(c);} }
  function removeItem(id,variant){ const c=readCart(); c.items=c.items.filter(x=>!(x.id===id&&x.variant===variant)); writeCart(c); }
  function clearCart(){ writeCart({items:[]}); }

  const tbody=document.getElementById('cart-rows');
  const totalEl=document.getElementById('cart-total');
  const emptyEl=document.getElementById('cart-empty');
  const tableEl=document.getElementById('cart-table');
  const buyerEl=document.getElementById('buyer-form');
  const payEl=document.getElementById('pay-card');
  function fmt(n){return (Math.round(n*100)/100).toFixed(2);}

  function renderCart(){
    const cart=readCart();
    tbody.innerHTML="";
    if(!cart.items.length){ emptyEl.style.display=""; tableEl.style.display="none"; buyerEl.style.display="none"; payEl.style.display="none"; updateCartBadge(); return; }
    emptyEl.style.display="none"; tableEl.style.display=""; buyerEl.style.display=""; payEl.style.display="";
    let total=0;
    cart.items.forEach(it=>{
      const sub=it.price*it.quantity; total+=sub;
      const tr=document.createElement('tr');
      tr.innerHTML=`
      <td><strong>${it.name}</strong><br><small>${it.id}${it.variant&&it.variant!=='default'?' • '+it.variant:''}</small></td>
      <td>$${fmt(it.price)}</td>
      <td><input type="number" min="1" value="${it.quantity}" style="width:70px"></td>
      <td>$${fmt(sub)}</td>
      <td><button type="button" class="link">Quitar</button></td>`;
      tr.querySelector('input').addEventListener('change',e=>{ setQty(it.id,it.variant||"default", parseInt(e.target.value,10)); renderCart(); });
      tr.querySelector('button').addEventListener('click',()=>{ removeItem(it.id,it.variant||"default"); renderCart(); });
      tbody.appendChild(tr);
    });
    totalEl.textContent=fmt(total); updateCartBadge();
  }
  renderCart();

  function buildPayload(){
    const cart=readCart();
    return {
      items: cart.items.map(i=>({ id:i.id, name:i.name, unitPrice:fmt(i.price), quantity:i.quantity, variant:i.variant||"default" })),
      discountCode: (document.getElementById('discount').value||"").trim(),
      buyerEmail: (document.getElementById('buyer-email').value||"").trim()
    };
  }

  paypal.Buttons({
    createOrder: ()=> {
      const p=buildPayload();
      if(!p.buyerEmail){ alert("Ingresa tu correo electrónico."); return; }
      return fetch('/.netlify/functions/create-order',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(p) })
        .then(r=>r.json()).then(d=>d.id);
    },
    onApprove: (data)=> fetch('/.netlify/functions/capture-order',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({orderID:data.orderID}) })
      .then(r=>r.json())
      .then(()=>{ localStorage.setItem("edn_cart_v1", JSON.stringify({items:[]})); window.location.href='/es-thank-you.html'; }),
    onError: (e)=>{ alert('Error de pago. Intenta de nuevo.'); console.error(e); }
  }).render('#paypal-button-container');
  </script>
</body>
</html>
