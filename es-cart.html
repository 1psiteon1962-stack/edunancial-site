<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Carrito — Edunancial</title>
  <link rel="stylesheet" href="/style.css">
</head>
<body>
  <header id="site-header" class="site-header"></header>

  <main class="container">
    <h1>Carrito</h1>

    <div class="card" id="cartCard" style="overflow:auto">
      <div id="emptyState" class="small" style="display:none">
        Tu carrito está vacío.
        <div style="margin-top:10px">
          <a class="btn" href="/es-books.html">Ver Libros</a>
          <a class="btn" href="/es-courses.html" style="margin-left:8px">Ver Cursos</a>
        </div>
      </div>

      <div id="cartTableWrap" style="display:none">
        <table id="cartTable">
          <thead>
            <tr>
              <th style="text-align:left">Artículo</th>
              <th>Cant.</th>
              <th>Precio</th>
              <th>Total</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="cartBody"></tbody>
          <tfoot>
            <tr>
              <td colspan="2"></td>
              <td style="text-align:right;font-weight:600">Subtotal:</td>
              <td id="subCell" style="text-align:right">$0.00</td>
              <td></td>
            </tr>
            <tr id="codeRow">
              <td colspan="5">
                <label for="code" class="small">Código de descuento / menor de 18:</label><br/>
                <input id="code" type="text" placeholder="Ingresa el código" />
                <button class="btn" id="applyBtn" style="margin-left:8px">Aplicar</button>
                <span id="codeMsg" class="small"></span>
              </td>
            </tr>
            <tr id="discRow" style="display:none">
              <td colspan="2"></td>
              <td style="text-align:right;font-weight:600">Descuento:</td>
              <td id="discCell" style="text-align:right">-$0.00</td>
              <td></td>
            </tr>
            <tr>
              <td colspan="2"></td>
              <td style="text-align:right;font-weight:800">Total:</td>
              <td id="totCell" style="text-align:right;font-weight:800">$0.00</td>
              <td></td>
            </tr>
          </tfoot>
        </table>

        <div style="margin-top:12px">
          <label for="email" class="small">Correo para recibos / acceso a Zoom:</label><br/>
          <input id="email" type="email" placeholder="tu@email.com" autocomplete="email" />
        </div>

        <div style="margin-top:14px">
          <button class="btn" id="checkoutBtn">Pagar con PayPal</button>
        </div>
      </div>
    </div>
  </main>

  <script src="/header.js?v=6" defer></script>
  <script>
  // Same logic as EN page; just keep text localized.
  (function(){
    const $ = sel => document.querySelector(sel);
    const cartKey = 'edn_cart'; const codeKey = 'edn_code';
    const priceMap = {
      'EDN-CRS-MIX-001': 75.00,'EDN-CRS-BO-001':199.00,
      'EDN-BK-RE-001':18.99,'EDN-BK-RE-002':18.99,
      'EDN-BK-PA-001':18.99,'EDN-BK-PA-002':18.99,
      'EDN-BK-BU-001':18.99,'EDN-BK-BU-002':18.99,
      'MEM-STARTER':5.00,'MEM-GROWTH':15.00,'MEM-PRO':25.00,
    };
    const flatPerItemCodes = { 'PR12345$$': 1.00 };
    function fmt(n){ return '$' + (Math.round(n*100)/100).toFixed(2); }
    function load(){ try {return JSON.parse(localStorage.getItem(cartKey)||'[]')} catch{ return [] } }
    function save(c){ localStorage.setItem(cartKey, JSON.stringify(c)); }
    function render(){
      const cart = load();
      if(!cart.length){ $('#emptyState').style.display=''; $('#cartTableWrap').style.display='none'; return; }
      $('#emptyState').style.display='none'; $('#cartTableWrap').style.display='';
      const code=(localStorage.getItem(codeKey)||'').replace(/\s+/g,'');
      const perItemTarget = flatPerItemCodes[code];
      const tbody=$('#cartBody'); tbody.innerHTML='';
      let sub=0;
      cart.forEach((l,i)=>{
        const sku=l.sku, qty=Math.max(1,l.qty||1);
        const unit = perItemTarget ? perItemTarget : (priceMap[sku]||0);
        const row = unit*qty; sub+=row;
        const tr=document.createElement('tr');
        tr.innerHTML = `
         <td style="text-align:left">${l.name||sku} <div class="small">SKU: ${sku}</div></td>
         <td style="text-align:center">${qty}</td>
         <td style="text-align:center">${fmt(unit)}</td>
         <td style="text-align:right">${fmt(row)}</td>
         <td style="text-align:center"><button class="link" data-rm="${i}">Quitar</button></td>`;
        tbody.appendChild(tr);
      });
      $('#subCell').textContent=fmt(sub);
      $('#discRow').style.display='none';
      $('#totCell').textContent=fmt(sub);
    }
    document.addEventListener('click',e=>{
      const i=e.target && e.target.getAttribute('data-rm');
      if(i!=null){ const c=load(); c.splice(parseInt(i,10),1); save(c); render(); }
    });
    $('#applyBtn').addEventListener('click', ()=>{ localStorage.setItem(codeKey, ($('#code').value||'').trim()); $('#codeMsg').textContent=' Código aplicado.'; render(); });
    $('#code').value = localStorage.getItem(codeKey)||'';
    $('#checkoutBtn').addEventListener('click', async ()=>{
      const cart=load(); if(!cart.length){ alert('Carrito vacío'); return; }
      const payload={ cart: cart.map(l=>({sku:l.sku,name:l.name,qty:l.qty,type:l.type||'item'})), code:(localStorage.getItem(codeKey)||'').trim(), email: $('#email').value.trim()||undefined };
      const res=await fetch('/.netlify/functions/create-order',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
      const data=await res.json();
      if(!res.ok||data.error){ alert('Error de pago: '+(data.error||'Desconocido')); return; }
      if(data.approveUrl){ location.href=data.approveUrl; } else { alert('No se encontró el enlace de aprobación.'); }
    });
    render();
  })();
  </script>
</body>
</html>
