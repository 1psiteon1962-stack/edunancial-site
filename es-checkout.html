<section class="pay-section">
  <h2>Secure Payment</h2>

  <div id="wallet-button" style="margin:16px 0;"></div>
  <div id="card-container" style="margin:16px 0;"></div>

  <label>Amount (USD)
    <input id="amount" type="number" min="1" step="1" value="49">
  </label>
  <button id="pay-btn">Pay Now</button>
  <pre id="pay-result" style="white-space:pre-wrap"></pre>
</section>

<script src="https://web.squarecdn.com/v1/square.js"></script>
<script>
(async function () {
  const cfg = await (await fetch('/api/square-config')).json();
  const payments = window.Square.payments(cfg.appId, cfg.locationId);

  // Apple Pay
  try {
    const ap = await payments.applePay({ countryCode: 'US', currencyCode: 'USD' });
    const apBtn = await ap.attach('#wallet-button');
    apBtn.addEventListener('click', async () => {
      const amount = Number(document.getElementById('amount').value)||0;
      const tok = await ap.tokenize({ total:{ label:'Edunancial', amount: amount.toFixed(2) }});
      await charge(tok.token, amount*100, tok);
    });
  } catch (e) {}

  // Google Pay
  try {
    const gp = await payments.googlePay({ countryCode: 'US', currencyCode: 'USD' });
    const gpBtn = await gp.attach('#wallet-button');
    gpBtn.addEventListener('click', async () => {
      const amount = Number(document.getElementById('amount').value)||0;
      const tok = await gp.tokenize({ total:{ label:'Edunancial', amount: amount.toFixed(2) }});
      await charge(tok.token, amount*100, tok);
    });
  } catch (e) {}

  // Card
  const card = await payments.card();
  await card.attach('#card-container');
  document.getElementById('pay-btn').addEventListener('click', async () => {
    const amount = Number(document.getElementById('amount').value)||0;
    const res = await card.tokenize();
    if (res.status !== 'OK') return document.getElementById('pay-result').textContent = 'Card tokenize failed.';
    await charge(res.token, amount*100);
  });

  async function charge(sourceId, amount, verificationToken){
    const r = await fetch('/api/square-pay', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ sourceId, amount, currency:'USD', note:'Website payment', verificationToken })
    });
    const data = await r.json();
    document.getElementById('pay-result').textContent = r.ok ? ('✅ Paid: '+data.payment?.id) : ('❌ '+JSON.stringify(data));
  }
})();
</script>
