<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Checkout | Edunancial</title>
  <link rel="stylesheet" href="/style.css"/>
  <style>
    .wrap{max-width:560px;margin:2rem auto;padding:1.25rem;border:1px solid #e5e7eb;border-radius:12px;background:#fff}
    h1{font-size:1.5rem;margin:0 0 .5rem}
    .muted{color:#6b7280;margin:0 0 1rem}
    label{font-weight:600;margin:.5rem 0 .25rem;display:block}
    input[type="number"],input[type="text"]{width:100%;padding:.65rem;border:1px solid #d1d5db;border-radius:8px}
    #card-container{margin:.75rem 0}
    .btn{display:inline-block;width:100%;padding:.85rem;border:0;border-radius:10px;font-weight:700;background:#111827;color:#fff}
    .btn-light{background:#fff;color:#111;border:1px solid #d1d5db}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:.5rem;margin-top:.75rem}
    .ok{color:#059669;font-weight:600;margin-top:.75rem}
    .err{color:#b91c1c;font-weight:600;margin-top:.75rem;white-space:pre-wrap}
    .badge{display:inline-block;background:#111827;color:#fff;border-radius:999px;padding:.25rem .6rem;font-size:.8rem;margin-left:.5rem}
  </style>
  <script src="https://web.squarecdn.com/v1/square.js"></script>
</head>
<body>
  <main class="wrap">
    <h1>Checkout<span id="prodBadge" class="badge" style="display:none"></span></h1>
    <p class="muted">Pay securely with card, Apple Pay, or Google Pay.</p>

    <label>Amount (USD)</label>
    <input id="amount" type="number" min="1" step="1" value="7500"/>

    <label style="margin-top:.75rem;">Description (shown on receipt)</label>
    <input id="desc" type="text" placeholder="Real Estate Mini-Course"/>

    <div id="wallet-container" style="margin-top:1rem;"></div>
    <div id="card-container"></div>
    <button id="pay" class="btn">Pay Now</button>

    <div id="msg"></div>
  </main>

  <script>
  (async function () {
    // 1) Read query params (?amount=7500&name=Title)
    const params = new URLSearchParams(location.search);
    const qAmount = params.get("amount");
    const qName   = params.get("name");
    if (qAmount) document.getElementById("amount").value = Number(qAmount);
    if (qName)   document.getElementById("desc").value   = decodeURIComponent(qName);
    if (qName) {
      const b = document.getElementById("prodBadge");
      b.textContent = decodeURIComponent(qName);
      b.style.display = "inline-block";
    }

    // 2) Get appId/locationId from server
    const cfg = await fetch("/api/config").then(r => r.json());
    if (!cfg.appId) {
      document.getElementById("msg").innerHTML =
        '<p class="err">Missing Square App ID on server.</p>';
      return;
    }
    const appId = cfg.appId, locationId = cfg.locationId;
    const msg  = document.getElementById("msg");

    // 3) Init Square
    const payments = window.Square.payments(appId, locationId);
    async function tryCreate(method) {
      try { return await payments[method](); }
      catch { return null; }
    }

    // Digital wallets
    const wallet = await tryCreate("paymentRequest");
    let walletBtn;
    if (wallet) {
      const pr = await payments.paymentRequest({
        countryCode: "US",
        currencyCode: "USD",
        total: { amount: (Number(document.getElementById("amount").value)/100).toFixed(2), label: "Edunancial" },
        requestShippingContact: false
      });
      const apple = await payments.applePay(pr).catch(()=>null);
      const google = await payments.googlePay(pr).catch(()=>null);

      if (apple || google) {
        walletBtn = document.createElement("button");
        walletBtn.className = "btn-light";
        walletBtn.style.marginBottom = ".5rem";
        walletBtn.textContent = apple ? "Apple Pay" : "Google Pay";
        document.getElementById("wallet-container").appendChild(walletBtn);
        walletBtn.addEventListener("click", async () => {
          const amount = Number(document.getElementById("amount").value);
          const note   = document.getElementById("desc").value || "Payment";
          try {
            const tokenResult = apple
              ? await apple.tokenize()
              : await google.tokenize();
            if (tokenResult.status !== "OK") throw new Error(tokenResult.status);
            await charge(tokenResult.token, amount, note);
          } catch (e) {
            msg.innerHTML = `<p class="err">Wallet error: ${e.message||e}</p>`;
          }
        });
      }
    }

    // Card form
    const card   = await payments.card();
    await card.attach("#card-container");

    document.getElementById("pay").addEventListener("click", async () => {
      const amount = Number(document.getElementById("amount").value);
      const note   = document.getElementById("desc").value || "Payment";
      msg.textContent = "";
      try {
        const r = await card.tokenize();
        if (r.status !== "OK") throw new Error(r.status);
        await charge(r.token, amount, note);
      } catch (e) {
        msg.innerHTML = `<p class="err">Card error: ${e.message||e}</p>`;
      }
    });

    async function charge(sourceId, amount, note) {
      const res = await fetch("/api/create-payment", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ sourceId, amount, currency: "USD", note })
      });
      const data = await res.json();
      if (!res.ok) {
        msg.innerHTML = `<p class="err">${(data.errors||[]).map(x=>x.detail).join("\n") || JSON.stringify(data)}</p>`;
        return;
      }
      msg.innerHTML = `<p class="ok">Paid! Receipt #${data.payment?.receipt_number||""}</p>`;
      setTimeout(()=>{ location.href = "/thank-you.html"; }, 800);
    }
  })();
  </script>
</body>
</html>
